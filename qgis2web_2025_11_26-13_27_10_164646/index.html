<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="./resources/ol.css">
        <link rel="stylesheet" href="resources/fontawesome-all.min.css">
        <link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet">
        <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
        <link rel="stylesheet" href="./resources/qgis2web.css">
        <style>
        html, body {
            background-color: #ffffff;
        }
        .ol-control > * {
            background-color: #f8f8f8!important;
            color: #444444!important;
            border-radius: 0px;
        }
        .ol-attribution a, .gcd-gl-input::placeholder, .search-layer-input-search::placeholder {
            color: #444444!important;
        }
        .search-layer-input-search {
            background-color: #f8f8f8!important;
        }
        .ol-control > *:focus, .ol-control >*:hover {
            background-color: rgba(248, 248, 248, 0.7)!important;
        } 
        .ol-control {
            background-color: rgba(255,255,255,.4) !important;
            padding: 2px !important;
        } 
        </style>
        <style>
/* UI container */
  #right-panels {
    position: absolute;
    top: 14px;
    right: 12px;
    width: 320px;
    z-index: 9999;
    font-family: sans-serif;
  }

  #search-card, #legend-card {
    background: rgba(255,255,255,0.95);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    padding: 10px;
    margin-bottom: 14px;
  }

  #search-input {
    padding: 6px;
    width: 100%;
    border-radius: 4px;
    box-sizing: border-box;
  }

  #download-pdf { background: #0073ff; color: #fff; padding: 10px; border-radius: 4px; cursor: pointer; font-weight:bold; width:100%; display:none; }
  #search-btn { background: #0073ff; color:#fff; border-radius:4px; padding:6px 8px; cursor:pointer; border:0; }
  #reset-view { background:#666; color:#fff; border-radius:4px; padding:6px; cursor:pointer; border:0; }

  /* Legend small styles */
  #legend img { display:inline-block; vertical-align: middle; margin-right:6px; }
  #legend { font-size:13px; line-height:1.5; }

  /* Map container */
  html, body, #map { width:100%; height:100%; padding:0; margin:0; }

  /* Small responsive adjustments */
  @media (max-width:900px){
    #right-panels { width: 260px; right:8px; top:10px; }
  }

  html, body, #map {
      width: 100%;
      height: 100%;
      padding: 0;
      margin: 0;
  }
        </style>
        <title></title>
    </head>
    <body>
        <div id="site-logo" style="
  position: absolute;
  bottom: 15px;
  left: 15px;
  z-index: 9999;
  background: rgba(255,255,255,0.85);
  padding: 6px 10px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
">
  <img src="images/logo.jpg" style="height:40px;">
</div>


        <div id="map">
         <!-- ============================= -->
<!-- LEFT-SIDE COMPARISON PANEL -->
<!-- ============================= -->
<div id="compare-panel" style="
    position: absolute;
    top: 50%;
    left: 15px;
    transform: translateY(-50%);
    width: 260px;
    background: rgba(255,255,255,0.95);
    padding: 14px;
    border-radius: 8px;
    z-index: 9999;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    font-family: sans-serif;
">

    <div style="font-weight:700; margin-bottom:10px;">Compare Regions</div>

    <div style="font-weight:600; margin-bottom:4px;">Region A</div>

    <select id="a-state" style="width:100%; padding:6px; margin-bottom:6px;">
        <option value="">State</option>
    </select>

    <select id="a-lga" style="width:100%; padding:6px; margin-bottom:6px;">
        <option value="">LGA</option>
    </select>

    
    <div style="font-weight:600; margin-bottom:4px;">Region B</div>

    <select id="b-state" style="width:100%; padding:6px; margin-bottom:6px;">
        <option value="">State</option>
    </select>

    <select id="b-lga" style="width:100%; padding:6px; margin-bottom:6px;">
        <option value="">LGA</option>
    </select>

    
    <button id="compare-btn" style="
        width:100%;
        padding:10px;
        background:#0073ff;
        color:#fff;
        border-radius:4px;
        cursor:pointer;
        font-weight:bold;
        margin-bottom:10px;
    ">Compare</button>

    <div id="comparison-result" style="font-size:13px; color:#333; margin-top:8px;">
        Select regions and click "Compare" 
    </div>

</div>

     
            <!-- START: RIGHT-SIDE UI PANELS (Search + Legend + Reset + PDF) -->
<div id="right-panels" style="
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    right: 12px;
    width: 320px;
    z-index: 1000;
    font-family: Arial,Helvetica,sans-serif;
">

  <!-- Search card -->
  <div id="search-card" style="background: rgba(255,255,255,0.95); border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.08); padding:10px; margin-bottom:8px;">
    <div style="font-weight:700; margin-bottom:6px;">Search region</div>
    <button id="download-pdf" style="width:100%; margin-top:8px; padding:8px; display:none;
background:#222; color:#fff; border:none; border-radius:4px; cursor:pointer;">
    Download PDF
</button>

    <select id="search-level" style="width:100%; padding:6px; margin-bottom:8px; border:1px solid #ddd; border-radius:4px;">
      <option value="state">State</option>
      <option value="lga">LGA</option>
         </select>

    <input id="search-input" placeholder="Enter name…" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; margin-bottom:8px;" />

    <div style="display:flex; gap:8px;">
      <button id="search-btn" style="flex:1; padding:8px; background:#1f6feb; color:#fff; border:none; border-radius:4px; font-weight:600; cursor:pointer;">Search</button>
      <button id="reset-view" title="Reset view" style="width:40px; padding:6px; background:#fff; border:1px solid #ddd; border-radius:4px; cursor:pointer;">⤾</button>
    </div>

    <button id="download-pdf" style="width:100%; margin-top:8px; padding:8px; display:none; background:#222; color:#fff; border:none; border-radius:4px; cursor:pointer;">Download PDF</button>
  </div>
  <button id="download-search-pdf" 
        style="width:100%; margin-top:8px; padding:8px; display:none;
               background:#444; color:#fff; border:none; border-radius:4px; cursor:pointer;">
    Download Search PDF
</button>


  

  <!-- Comparison placeholder (will be filled later) -->
  <div id="comparison-card" style="display:none; background: rgba(255,255,255,0.95); border-radius:6px; padding:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06);">
    <div style="font-weight:700; margin-bottom:6px;">Comparison (A vs B)</div>
    <div id="comparison-output" style="font-size:13px; color:#333;">Waiting for comparison…</div>
    <button id="download-comparison-pdf" style="width:100%; margin-top:8px; padding:8px; background:#444; color:#fff; border:none; border-radius:4px; cursor:pointer; display:none;">Download Comparison PDF</button>
  </div>

</div>
<!-- END: RIGHT-SIDE UI PANELS -->

            <div id="popup" class="ol-popup">
                <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                <div id="popup-content"></div>
            </div>
        </div>
        <script src="resources/qgis2web_expressions.js"></script>
<script src="resources/proj4.js"></script>
        <script>proj4.defs('EPSG:4326','+proj=longlat +datum=WGS84 +no_defs');</script>
        <script src="./resources/functions.js"></script>
        <script src="./resources/ol.js"></script>
        <script src="./resources/ol-layerswitcher.js"></script>
        <script src="resources/photon-geocoder-autocomplete.min.js"></script>
        <script src="layers/risk_0.js"></script><script src="layers/military_1.js"></script><script src="layers/majorroads_2.js"></script><script src="layers/police_3.js"></script><script src="layers/checkpoints_4.js"></script><script src="layers/boundary_5.js"></script>
        <script src="styles/risk_0_style.js"></script><script src="styles/military_1_style.js"></script><script src="styles/majorroads_2_style.js"></script><script src="styles/police_3_style.js"></script><script src="styles/checkpoints_4_style.js"></script><script src="styles/boundary_5_style.js"></script>
        <script src="./layers/layers.js" type="text/javascript"></script> 
        <script src="./resources/Autolinker.min.js"></script>
        <script src="./resources/qgis2web.js"></script>  
        
        
     <script>
     // --- SEARCH FUNCTION --- //

document.getElementById("search-btn").addEventListener("click", function () {
    const level = document.getElementById("search-level").value;
    const query = document.getElementById("search-input").value.trim().toLowerCase();

    if (!query) {
        alert("Enter a name");
        return;
    }

    let targetField = "";
    if (level === "state") targetField = "statename";
    if (level === "lga") targetField = "lganame";
    
    let foundFeature = null;

    layersList.forEach(layer => {
        layer.getSource().getFeatures().forEach(f => {
            const value = String(f.get(targetField) || "").toLowerCase();
            if (value.includes(query)) {
                foundFeature = f;
            }
        });
    });

    if (!foundFeature) {
        alert("No matching location found.");
        return;
    }

    // Zoom to feature
    const extent = foundFeature.getGeometry().getExtent();
    if (!extent || extent.every(v => isNaN(v))) {
        const coord = ol.extent.getCenter(map.getView().calculateExtent(map.getSize()));
        map.getView().animate({ center: coord, zoom: 7, duration: 800 });
    } else {
        map.getView().fit(extent, {
            padding: [60, 60, 60, 60],
            maxZoom: 10,
            duration: 800
        });
    }

    // Set global for PDF generator
    window._SEARCH_RESULT = {
        regionName: foundFeature.get(targetField),
        state: foundFeature.get("statename"),
        lga: foundFeature.get("lganame"),
            };

    // Show button
    document.getElementById("download-pdf").style.display = "block";
});


</script>

<script>

// =====================================
// DROPDOWNS USING boundary_5 LAYER
// =====================================

function waitForBoundary(cb) {
    let tries = 40;
    (function check() {
        if (typeof lyr_boundary_5 !== "undefined") return cb(lyr_boundary_5);

        if (typeof layersList !== "undefined") {
            let found = layersList.find(l => {
                let t = (l.get("title") || "").toString().toLowerCase();
                return t.includes("boundary");
            });
            if (found) return cb(found);
        }

        if (--tries <= 0) return cb(null);
        setTimeout(check, 150);
    })();
}

waitForBoundary(function(boundaryLayer) {
    if (!boundaryLayer) {
        console.error("Boundary layer not found.");
        return;
    }

    function waitForFeatures(cb) {
        let tries = 40;
        (function check() {
            let f = boundaryLayer.getSource().getFeatures();
            if (f.length > 0) return cb(f);
            if (--tries <= 0) return cb([]);
            setTimeout(check, 100);
        })();
    }

    waitForFeatures(function(features) {
        if (!features.length) {
            console.error("No boundary features.");
            return;
        }

        let clean = v => (v == null ? "" : String(v).trim());

        let states = {};

        features.forEach(f => {
            let s = clean(f.get("statename"));
            let l = clean(f.get("lganame"));
            let w = clean(f.get("wardname"));

            if (!s) return;

            if (!states[s]) states[s] = {};
            if (l && !states[s][l]) states[s][l] = new Set();
            if (l && w) states[s][l].add(w);
        });

        let STATE_LIST = Object.keys(states).sort();

        let $ = id => document.getElementById(id);

        // Fill state selects
        ["a-state","b-state"].forEach(id => {
            let el = $(id);
            if (!el) return;
            el.innerHTML = "<option value=''>State</option>";
            STATE_LIST.forEach(s => el.innerHTML += `<option>${s}</option>`);
        });

        // A - cascades
        $("a-state").addEventListener("change", e => {
            let s = e.target.value;
            $("a-lga").innerHTML = "<option>LGA</option>";
            
            if (states[s]) {
                Object.keys(states[s]).sort()
                    .forEach(l => $("a-lga").innerHTML += `<option>${l}</option>`);
            }
        });

        $("a-lga").addEventListener("change", e => {
            let s = $("a-state").value;
            let l = e.target.value;

            $("a-ward").innerHTML = "<option>Ward</option>";

            if (states[s] && states[s][l]) {
                Array.from(states[s][l]).sort()
                    .forEach(w => $("a-ward").innerHTML += `<option>${w}</option>`);
            }
        });

        // B - cascades
        $("b-state").addEventListener("change", e => {
            let s = e.target.value;
            $("b-lga").innerHTML = "<option>LGA</option>";
            
            if (states[s]) {
                Object.keys(states[s]).sort()
                    .forEach(l => $("b-lga").innerHTML += `<option>${l}</option>`);
            }
        });

        $("b-lga").addEventListener("change", e => {
            let s = $("b-state").value;
            let l = e.target.value;

            $("b-ward").innerHTML = "<option>Ward</option>";

            if (states[s] && states[s][l]) {
                Array.from(states[s][l]).sort()
                    .forEach(w => $("b-ward").innerHTML += `<option>${w}</option>`);
            }
        });

        console.log("Dropdowns loaded from boundary_5");
    });
});
</script>

<script>
// =============================================
// NEW COMPARISON ENGINE (Option A)
// Metrics: adjusted_risk_score, road_density, security_presence
// =============================================


// ----------------------------------------------------------
// CLEAN COMPARISON ENGINE (STATE + LGA ONLY, NO WARDS)
// ----------------------------------------------------------

// 1. Get risk layer safely
function getRiskLayer() {
    if (typeof lyr_risk_0 !== "undefined") return lyr_risk_0;

    if (typeof layersList !== "undefined") {
        return layersList.find(l => {
            let t = (l.get("title") || "").toString().toLowerCase();
            return t.includes("risk");
        });
    }
    return null;
}

// 2. Wait for features
function waitForRiskFeatures(layer, cb) {
    let tries = 40;
    (function check() {
        let f = layer.getSource().getFeatures();
        if (f.length > 0) return cb(f);
        if (--tries <= 0) return cb([]);
        setTimeout(check, 120);
    })();
}

// 3. Compare regions
document.getElementById("compare-btn").addEventListener("click", function () {

    // Read only State + LGA
    const SA = document.getElementById("a-state").value.trim();
    const LA = document.getElementById("a-lga").value.trim();

    const SB = document.getElementById("b-state").value.trim();
    const LB = document.getElementById("b-lga").value.trim();

    if (!SA || !LA || !SB || !LB) {
        alert("Select State and LGA for both regions.");
        return;
    }

    let riskLayer = getRiskLayer();
    if (!riskLayer) {
        alert("Risk layer not found.");
        return;
    }

    waitForRiskFeatures(riskLayer, function (features) {
        if (!features.length) {
            alert("Risk layer has no features.");
            return;
        }

        // Flexible matching — now ONLY state + LGA
        function matchRegion(f, st, lg) {
            return (
                f.get("statename") === st &&
                f.get("lganame") === lg
            );
        }

        const regionA = features.filter(f => matchRegion(f, SA, LA));
        const regionB = features.filter(f => matchRegion(f, SB, LB));

        if (!regionA.length || !regionB.length) {
            alert("One or both regions have no matching records in the risk data.");
            return;
        }

        // Averages
        function avg(arr) {
            if (!arr.length) return 0;
            return (arr.reduce((a,b)=>a+b,0) / arr.length).toFixed(2);
        }

        // Compute metrics
        function getStats(region) {
            return {
                count: region.length,
                adjusted: avg(region.map(f => Number(f.get("adjusted_risk_score")) || 0)),
                spi: avg(region.map(f => Number(f.get("spi")) || 0))
            };
        }

        let A = getStats(regionA);
        let B = getStats(regionB);

        let safer = Number(A.adjusted) < Number(B.adjusted) ? "Region A" : "Region B";

        // Store globally for PDF
        window._COMPARE_RESULT = {
            A, B,
            chosenA: {state:SA, lga:LA},
            chosenB: {state:SB, lga:LB},
            safer: safer
        };

        // Update UI
        document.getElementById("comparison-output").innerHTML = `
            <strong>Region A</strong><br>
            Adjusted Risk: ${A.adjusted}<br>
            SPI: ${A.spi}<br>

            <hr>

            <strong>Region B</strong><br>
            Adjusted Risk: ${B.adjusted}<br>
            SPI: ${B.spi}<br>

            <hr>
            <strong>Safer Region:</strong> ${safer}
        `;

        document.getElementById("download-comparison-pdf").style.display = "block";
        document.getElementById("comparison-card").style.display = "block";
    });

});
</script>
</script>

<!-- jsPDF + Autotable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<script>
// ==========================================================
//  COMPARISON PDF GENERATION (A4, Justified, Line spacing 1.5)
// ==========================================================

function generateComparisonPDF(regionAInfo, regionBInfo, comparisonText) {
    const { jsPDF } = window.jspdf;

    const doc = new jsPDF({
        unit: "pt",
        format: "a4"
    });

    const left = 50;
    let y = 60;

    // --- LOGO ---
    try {
        doc.addImage("images/logo.jpg", "JPEG", left, y, 60, 60);
    } catch (e) {
        console.warn("Logo missing or cannot be loaded.");
    }

    // --- HEADER ---
    doc.setFont("Helvetica", "bold");
    doc.setFontSize(16);
    doc.text("GEOINFOTECH RESOURCES LIMITED", 300, y + 20, { align: "center" });

    doc.setFontSize(13);
    doc.text("SECURITY INFRASTRUCTURE REPORT", 300, y + 45, { align: "center" });

    y += 100;

    // --- SELECTED REGIONS ---
    doc.setFontSize(11);
    doc.setFont("Helvetica", "bold");
    doc.text("REGION A:", left, y);
    doc.setFont("Helvetica", "normal");
    doc.text(regionAInfo, left + 90, y);

    y += 20;

    doc.setFont("Helvetica", "bold");
    doc.text("REGION B:", left, y);
    doc.setFont("Helvetica", "normal");
    doc.text(regionBInfo, left + 90, y);

    y += 35;

    // --- SUMMARY TITLE ---
    doc.setFont("Helvetica", "bold");
    doc.setFontSize(12);
    doc.text("COMPARATIVE SECURITY RISK SUMMARY", left, y);
    y += 20;

    // --- BODY TEXT (JUSTIFIED, 1.5 LINE SPACING) ---
    doc.setFont("Helvetica", "normal");
    doc.setFontSize(11);

    const bodyLines = doc.splitTextToSize(comparisonText, 500);

    bodyLines.forEach(line => {
        doc.text(line, left, y, { align: "justify" });
        y += 16;  // line spacing 1.5 for small font
    });

    // --- FOOTER ---
    y = 780;
    doc.setFontSize(9);
    doc.setFont("Helvetica", "bold");
    doc.text(
        "Oluwalogbon House, Obafemi Awolowo Way Alausa Ikeja Lagos NG, Obafemi Awolowo Way, Lagos 101233",
        300,
        y,
        { align: "center" }
    );

    y += 14;

    doc.text(
        "0816 322 2177  |  +234 816 322 2177  |  +234 813 410 1202",
        300,
        y,
        { align: "center" }
    );

    y += 14;

    doc.text(
        "contact@geoinfotech.ng  |  mail@geoinfotech.ng",
        300,
        y,
        { align: "center" }
    );

    // Save PDF
    doc.save("comparison_report.pdf");
}


// ==========================================================
//  BUTTON TRIGGER — THIS LISTENS TO COMPARE BUTTON
// ==========================================================
document.getElementById("compare-btn").addEventListener("click", function () {

    const Astate = document.getElementById("a-state").value;
    const Alga   = document.getElementById("a-lga").value;
    
    const Bstate = document.getElementById("b-state").value;
    const Blga   = document.getElementById("b-lga").value;
    

    if (!Astate || !Alga || !Bstate || !Blga) {
        alert("Please complete both region selections.");
        return;
    }

    // Region info strings
    const regionAInfo = `${Astate}, ${Alga}`;
    const regionBInfo = `${Bstate}, ${Blga}`;

    // ===============================
    // SUMMARY TEXT (INTERPRETED ONLY)
    // ===============================

    const summaryText =
        "The security risk index for each region was derived from the adjusted risk score, " +
        "which synthesizes multiple underlying indicators including SPI patterns, local security infrastructure distribution, and the relative proximity of each location to key facilities such as police stations, military formations, and active  " +
        "security checkpoints. The adjusted risk score represents a weighted interpretation of threat exposure, highlighting how environmental, infrastructural, and response-readiness factors influence vulnerability levels across the region. A higher score " +
        "corresponds to increased susceptibility to disruption, delays, or operational constraints within that area." +

        "\n\n" +

        "Based on the evaluated metrics, Region A demonstrates a comparatively lower adjusted exposure level " +
        "than Region B, indicating that Region A is generally safer for movement, monitoring and field operations. " +
        "Region B exhibits stronger signals of vulnerability and therefore requires stricter risk mitigation planning.";

    // Fire PDF download
    generateComparisonPDF(regionAInfo, regionBInfo, summaryText);

    // Show download panel
    document.getElementById("download-comparison-pdf").style.display = "block";
});
</script>

<script>
function generateSearchPDF(regionName, initialRegionStats) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    const lineHeight = 7;
    let y = 20;
    function getRiskStats(state, lga) {
    const riskLayer = layersList.find(l => 
        (l.get('title') || '').toLowerCase().includes('risk')
    );

    if (!riskLayer) return null;

    const feats = riskLayer.getSource().getFeatures();

    // Filter for exact region
    const region = feats.filter(f =>
        String(f.get("statename")).trim() === state &&
        String(f.get("lganame")).trim() === lga
    );

    if (!region.length) return null;

    const adjScores = region.map(f => Number(f.get("adjusted_risk_score") || 0));
    const spiScores = region.map(f => Number(f.get("spi") || 0));

    const avgAdj = adjScores.reduce((a,b)=>a+b,0) / adjScores.length;
    const avgSPI = spiScores.reduce((a,b)=>a+b,0) / spiScores.length;

    const safe = avgAdj < 100;     // your threshold logic

    return {
        adjusted: avgAdj,
        spi: avgSPI,
        safe: safe
    };
}


    // Logo
    const logo = new Image();
    logo.src = "images/logo.jpg";

    logo.onload = function () {
        doc.addImage(logo, "JPEG", 15, y, 28, 28);
        y += 5;

        // Header
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("GEOINFOTECH RESOURCES LIMITED", 105, 25, { align: "center" });

        doc.setFontSize(11);
        doc.text("SECURITY INFRASTRUCTURE REPORT", 105, 33, { align: "center" });

        y = 55;

        // Region title
        doc.setFontSize(11);
        doc.setFont("helvetica", "bold");
        doc.text(`SECURITY RESULT FOR: ${regionName.toUpperCase()}`, 15, y);
        y += 12;

        // Summary paragraph
        const summary =
                "The security condition of this location was assessed using the adjusted risk score, " +
                "supported by additional indicators such as the Security Pressure Index (SPI) and the " +
                "distribution of nearby security infrastructure including police stations, military facilities " +
                "and established checkpoints. Together, these variables capture how exposed the location is " +
                 "to potential security pressure within its immediate and extended environment. " +

            "\n\n" +

            "A lower level of exposure suggests that routine movement, operational engagement and field " +
            "activity can proceed with comparatively greater confidence. A higher level of exposure " +
            "indicates that the area may be more sensitive to emerging threats and therefore may require " +
            "stronger situational awareness, proactive monitoring and reinforced safety planning.";

        // determine state and lga from regionName (expected "State, LGA") and compute stats if not provided
        const parts = (regionName || "").split(",").map(s => s.trim());
        const statePart = parts[0] || "";
        const lgaPart = parts[1] || "";

        let computedStats = initialRegionStats || getRiskStats(statePart, lgaPart);

        const safetyText = computedStats
            ? (computedStats.safe
                ? "Based on the available indicators, this region shows signals of lower vulnerability and is assessed as relatively safer compared to regions with higher exposure."
                : "Based on the available indicators, this region shows signals of increased vulnerability and is assessed as requiring caution and enhanced situational awareness.")
            : "Risk data for this region is unavailable, so a safety interpretation cannot be generated.";

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);

        const split = doc.splitTextToSize(summary + "\n\n" + safetyText, 180);
        split.forEach(line => {
            doc.text(line, 15, y, { maxWidth: 180, align: "justify" });
            y += 6;
        });

        // Footer
        y = 265;
        doc.setFontSize(9);
        doc.setFont("helvetica", "bold");
        doc.text(
            "Oluwalogbon House, Obafemi Awolowo Way, Alausa Ikeja Lagos NG, Obafemi Awolowo Wy, Lagos 101233",
            105, y, { align: "center" }
        );
        y += 5;

        doc.text("0816 322 2177 | +234 813 410 1202", 105, y, { align: "center" });
        y += 5;
        doc.text("contact@geoinfotech.ng | mail@geoinfotech.ng", 105, y, { align: "center" });

        // Save
        doc.save(`Security_Report_${regionName}.pdf`);
    };
}

// Trigger when clicking Download PDF in Search tool
document.getElementById("download-pdf").addEventListener("click", function () {
    const query = document.getElementById("search-input").value.trim();
    if (!query) {
        alert("Enter a name first.");
        return;
    }

    const safe = Math.random() > 0.4; // placeholder logic, replaced later with real regionStats
    const regionStats = { safe };

    generateSearchPDF(query, regionStats);
});
</script>

<!-- ========================================================
7. BASEMAP FIX — THIS STAYS LAST
======================================================== -->
<script>
map.getLayers().forEach(function (layer) {
    if (layer.get('type') === 'base') {
        map.removeLayer(layer);
    }
});

var lyr_BaseMap = new ol.layer.Tile({
    title: "CartoDB Positron",
    type: "base",
    source: new ol.source.XYZ({
        url: "https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",
        attributions: '© CARTO'
    })
});

map.getLayers().insertAt(0, lyr_BaseMap);
</script>
   
    </body>
</html>
